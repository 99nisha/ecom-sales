---
title: "Customer Behaviour"
output: html_notebook
---

```{r}
# install.packages("dplyr")
# install.packages("tidyr")
# install.packages("lubridate")
# install.packages("ggplot")
# install.packages("ggcorrplot")
# install.packages("caret")
# install.packages("lattice")
# install.packages("recipes")

library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(ggcorrplot)
library(caret)
library(broom)
library(rlang)
library(scales)
library(stringr)
```

```{r}
df <- read.csv("Tidy.csv")
```

```{r}
df <- df %>%
  mutate(order_date = ymd(order_date))

# Define the analysis date as the day after the last transaction date
analysis_date <- max(df$order_date, na.rm = TRUE) + days(1)

customer_performance <- df %>%
  group_by(customer_id) %>%
  summarise(
    customer_age = first(customer_age),
    age_group = first(age_group),
    customer_gender = first(customer_gender),
    monetary_value = sum(total_amount, na.rm = TRUE),
    total_gross_profit = sum(profit_margin, na.rm = TRUE),
    total_returns = sum(returned == "Yes"),
    frequency = n(),
    recency_days = as.numeric(analysis_date - max(order_date, na.rm = TRUE)),
    .groups = 'drop' # Recommended to un-group after summarising
  ) %>%
  
  mutate(
    AOV = monetary_value / frequency
  ) %>%

  # 1. Calculate Score for Monetary Value (3=Highest, 1=Lowest)
  mutate(
    M_Score = case_when(
      # Top 33.3% of spending
      monetary_value >= quantile(monetary_value, 0.666) ~ 3,
      # Middle 33.3% of spending
      monetary_value >= quantile(monetary_value, 0.333) ~ 2,
      # Bottom 33.3% of spending
      TRUE ~ 1
    )
  ) %>%
  
  # 2. Calculate Score for Frequency (3=Highest, 1=Lowest)
  mutate(
    F_Score = case_when(
      # Top 33.3% of orders
      frequency >= quantile(frequency, 0.666) ~ 3,
      # Middle 33.3% of orders
      frequency >= quantile(frequency, 0.333) ~ 2,
      # Bottom 33.3% of orders
      TRUE ~ 1
    )
  ) %>%
  
  # 3. Recency Score (Inverse scoring: Low days = High Score)
  mutate(
    R_Score = case_when(
      recency_days <= quantile(recency_days, 0.333) ~ 3, # Top 33.3% most recent orders get score 3
      recency_days <= quantile(recency_days, 0.666) ~ 2,
      TRUE ~ 1
    )
  ) %>%
  
  # 4. Calculate the Combined RF Score (Sum of M_Score and F_Score)
  mutate(
    RFM_Score = M_Score + F_Score + R_Score # Total score ranges from 3 to 9
  ) %>%
  
  # 5. Assign Final Tier based on Combined Score (Max Score is 6)
  mutate(
    customer_tier = case_when(
      RFM_Score >= 8 ~ "Gold",
      RFM_Score >= 5 ~ "Silver",
      TRUE ~ "Bronze"
    )
  )

customer_performance

write.csv(customer_performance, "Export/customer_performance.csv")
```


```{r}

calculate_customer_contribution <- function(data, ...) {
  # Capture all grouping variables passed via '...'
  grouping_vars <- rlang::enquos(...)
  
  if (length(grouping_vars) == 0) {
    stop("Please provide at least one grouping variable (e.g., customer_tier, age_group).")
  }
  
  results <- customer_performance %>%
  group_by(!!!grouping_vars) %>%
  summarise(
    AOV = mean(AOV, na.rm = TRUE),
    mean_profit = mean(total_gross_profit, na.rm = TRUE),
    group_total_profit = sum(total_gross_profit, na.rm = TRUE),
    group_total_returns = sum(total_returns, na.rm = TRUE),
    
    # Risk Metric: Average Recency Score (R_Score is inversely related to Recency Risk)
    customer_count = n(),
    avg_r_score = mean(R_Score, na.rm = TRUE),
    
    .groups = 'drop'
  ) %>%
  
  mutate(
    contribution_percent = (group_total_profit / sum(group_total_profit, na.rm = TRUE)) * 100
  ) %>%
    
  mutate(
    return_percent = (group_total_returns / sum(group_total_returns, na.rm = TRUE)) * 100
  ) %>%

  mutate(
    # Calculate the Return Rate (Returns per Customer) for a more direct metric
    returns_per_customer = group_total_returns / customer_count,
    
    churn_risk_level = case_when(
      # HIGH RISK: Low Recency Score (High churn indicator) AND High Return Rate (Dissatisfaction)
      (avg_r_score <= 1.5) & (returns_per_customer > 0.05) ~ "HIGH",
      
      # MEDIUM RISK: Mid-range Recency Score OR High Returns, but not both
      (avg_r_score <= 2.5) | (returns_per_customer > 0.03) ~ "MEDIUM",
      
      # LOW RISK: High Recency Score (Recent buyers) and Low Returns
      TRUE ~ "LOW"
    )
  ) %>%
  
  arrange(desc(contribution_percent))
  
  return(results)
}

# Group by Tier AND Age Group
age_tier_contribution_results <- calculate_customer_contribution(
  data = customer_performance, 
  age_group, 
  customer_tier
)

# Group by Tier AND Gender
gender_tier_contribution_results <- calculate_customer_contribution(
  data = customer_performance, 
  customer_gender,
  customer_tier
)

# --- Display Results ---

cat("--- Results Grouped by Age Group Only ---\n")
print(age_tier_contribution_results)
cat("\n")
cat("--- Results Grouped by Age Group AND Customer Tier ---\n")
print(gender_tier_contribution_results)


# --- Export the Results ---
write.csv(age_tier_contribution_results, "Export/customer_age_tier_contributions.csv", row.names = FALSE)
write.csv(gender_tier_contribution_results, "Export/customer_gender_tier_contributions.csv", row.names = FALSE)
```


```{r}
calculate_category_tier_contribution <- function(...) {
  
  # Capture all grouping variables passed via '...'
  grouping_vars <- rlang::enquos(...)
  
  if (length(grouping_vars) == 0) {
    stop("Please provide at least one grouping variable.")
  }
  
  # 1. Prepare lookup table: customer_id and customer_tier
  tier_lookup <- customer_performance %>%
    select(customer_id, customer_tier) %>%
    distinct() 
  
  # 2. Join Tier to Transactional Data (df)
  # This merges the customer tier into every transactional row.
  df_merged <- df %>%
    left_join(tier_lookup, by = "customer_id") %>%
    filter(!is.na(customer_tier))
    
  # 3. Perform Grouping and Summarization
  results <- df_merged %>%
    group_by(!!!grouping_vars) %>%
    summarise(
      # Correctly calculate the SUM of transactional profit margin (Total Profit for the segment)
      total_profit_margin_sum = sum(profit_margin, na.rm = TRUE),
      # Count the number of orders in this segment
      order_count = n(),
      .groups = 'drop'
    ) %>%
    
    # 4. Calculate Contribution Percentage (to the grand total profit margin)
    mutate(
      contribution_percent = (total_profit_margin_sum / sum(total_profit_margin_sum, na.rm = TRUE)) * 100
    ) %>%
    
    arrange(desc(total_profit_margin_sum))
  
  return(results)
}

# Execute the function call as requested by the user
category_tier_contribution_results <- calculate_category_tier_contribution(category, customer_tier)

# Print the result
print(category_tier_contribution_results)

# Export
write.csv(category_tier_contribution_results, "Export/category_tier_contributions.csv", row.names = FALSE)
```







